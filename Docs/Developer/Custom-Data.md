Custom Data
===========

The Launcher of the MuCaREX and the "mds" module (see
Docs/User/High-Score.md) does allow games to load/store custom data on
the flash. Using this method save games, configuration or other data can
be stored.

A game has to be adapted in order to do so.


Basics
------

When starting a game the Launcher will check if data is stored and load
it. If there is no stored data then a "new" data is created.

After a reset the Launcher checks if data should be stored and does so
if required.

Important: The data is only stored on a reset!


Memory Usage
------------

The last up to 8 KiB of the new 16 KiB RAM of the MuCaREX is used to
store an header and the data. The built in 1 KiB RAM is not used for the
feature.

* $a000 - $bfef Area for custom data
* $bff0 - $bff9 `ID` "CUSTOMDATA"
* $bffa `Type`
* $bffb `Flags`
* $bffc-$bffd `Length`
* $bffe-$bfff `Address`

The `ID` has to be "CUSTDATA", this is only to identify an Vectrex with
advanced storage method.

The `Type` will be either:

* "n" when no data is saved yet (Loader)
* "l" when saved data is loaded (Loader)
* "s" when the data should be saved (You)

`Flags` should be $00 for now (and are on load/new).

The `Length` is the length of the load / to be stored data, valid range
is 1-1024.

The `Address` points to the data, must be within the Area.


Start
-----

The Launcher will do either:

* Make sure that `ID` and/or `Type` is invalid when no storage module is available
* Set `ID` correctly and `Type` to "n" when the storage is available but no data is yet stored
* Set everything (`Type` to "l") when data is loaded, the data is of course also loaded and `Address` will point to it

When starting on another system the memory will contain probably random
data, if there is RAM at all.


Reset
-----

When the `ID` is correct and `Type` is "s" (and `Length`/`Address` is
valid) the data is stored.


Force a Data Store
------------------

In order to force to store the data to flash do:

* Setup the memory correctly (as described above)
* Set the bit `CUSTOMDATA_FLAG_DO_RESTART` in `Flags`
* Issue a reset by: `jmp [$fffe]`
* The Launcher will store the data and restart the game immediately
* The game will be launched with the bit `CUSTOMDATA_FLAG_DID_RESTART` set in `Flags`


Example
-------

See Vectrex/custom-data-test.asm for an simple example which stores an
custom string in the data. That program does issue an reset on any
button press. It's included in the example game collection.


Game ID
-------

A "Game ID" is used to distinct between the different scores/data stored
on the flash. If no Game ID is given it's automatically generated by an
md5 over the whole binary.

Since this is not helpful when developing new software because the ID
would change every time a bit in the game changes it's possible to
specify a fixed Game ID.

In order to do so the last 16 bytes of your binary have to be the
desired Game ID and the 8 bytes before that have to be an Game ID header
(see `GAME_ID_HEADER` in Vectrex/custom-data.inc).

The binary can have any size, it must not be a power of two or whatever.
